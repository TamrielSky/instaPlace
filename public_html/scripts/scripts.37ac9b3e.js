"use strict";angular.module("instaPlaceApp",["ngAnimate","ngAria","ngCookies","ngMessages","ngResource","ngSanitize","ngTouch","uiGmapgoogle-maps","ui.router","uiRouterStyles","ngAutocomplete","ui.bootstrap-slider","ngStorage","ui-listView","angular-loading-bar"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/home"),a.state("home",{url:"/home",views:{"":{templateUrl:"views/home.html",controller:"homeCtrl",controllerAs:"homePage"},"autocompleteView@home":{templateUrl:"views/autocomplete.html",controller:"autocompleteCtrl",controllerAs:"autocomplete"},"listView@home":{templateUrl:"views/listView.html",controller:"listCtrl"},"mapView@home":{templateUrl:"views/mapView.html",controller:"mapsCtrl",controllerAs:"mapConfig"},"placeDescribeView@home":{templateUrl:"views/describePlace.html"}}}).state("about",{url:"/about",templateUrl:"views/about.html"})}]),angular.module("instaPlaceApp").controller("mapsCtrl",["$localStorage","$scope",function(a,b){this.windowOptions={visible:!1};var c=[{featureType:"all",stylers:[{saturation:-80}]},{featureType:"road.arterial",elementType:"geometry",stylers:[{hue:"#00ffee"},{saturation:50}]},{featureType:"poi.business",elementType:"labels",stylers:[{visibility:"off"}]}];b.options={styles:c},this.currentLocationMarker={options:{icon:{url:"../images/blue_dot_circle.c9ce3a8b.png"}}},this.markers={gas_station:{options:{icon:{url:"../images/gas_station-marker.644471ef.png",scaledSize:new google.maps.Size(30,30)}}},restaurant:{options:{icon:{url:"../images/restaurant-marker.3014fe28.png",scaledSize:new google.maps.Size(30,30)}}},atm:{options:{icon:{url:"../images/atm-marker.d83ece56.png",scaledSize:new google.maps.Size(30,30)}}},bar:{options:{icon:{url:"../images/bar-marker.4c8b97ab.png",scaledSize:new google.maps.Size(30,30)}}},grocery:{options:{icon:{url:"../images/grocery-marker.f330c278.png",scaledSize:new google.maps.Size(30,30)}}},airport:{options:{icon:{url:"../images/atm-marker.d83ece56.png",scaledSize:new google.maps.Size(30,30)}}},hospital:{options:{icon:{url:"../images/hospital-marker.98a43f08.png",scaledSize:new google.maps.Size(30,30)}}}}}]),angular.module("instaPlaceApp").controller("homeCtrl",["geolocationService","placeFilterService","$localStorage","$scope","uiGmapIsReady","$timeout",function(a,b,c,d,e,f){var g=this,h=new google.maps.DirectionsRenderer({suppressMarkers:!0});g.loadingStyle={visibility:"visible"},g.mapZoom=14,g.filteredPlaces=null,g.normalizedPlaces=[],g.markers=[],g.searchFilter=[],g.sliderModel=1,g.infoWindow={show:!1,name:null,address:null,coords:null},g.gmapCircle={visible:!0,stroke:{color:"#DC381F",weight:1,opacity:.1},fill:{color:"#DC381F",opacity:.1},control:{}},a.getLocation().then(function(b){var c=$(".mainview").height()-$(".autocomplete").height()-25;return $(".angular-google-map-container").height(c),$(".ui-list-view").height($(".mapWrapper").height()-70),b={coords:{latitude:b.coords.latitude,longitude:b.coords.longitude}},g.location=b,g.setLoadingVisible(!1),a.getAddress(b.coords)}).then(function(a){g.currentAddress=a,g.currentLocation=angular.copy(g.location),d.$apply()}),e.promise().then(function(a){g.map=a[0].map}),d.$on("update_location",function(a,b){g.mapZoom=14,g.location={coords:{latitude:b.geometry.location.lat(),longitude:b.geometry.location.lng()}},g.currentLocation=angular.copy(g.location),g.filteredPlaces=[]}),this.setLoadingVisible=function(a){a?g.loadingStyle.visibility="visible":g.loadingStyle.visibility="hidden"},this.searchNearByPlaces=function(){function c(a){if(a)for(var b in a)e[b]?e[b]=e[b].concat(a[b]):e[b]=a[b]}g.setLoadingVisible(!0);var e={},f=Promise.resolve();a.getLatLngFromAddress(this.currentAddress).then(function(i){g.location={coords:{latitude:i.lat(),longitude:i.lng()}},g.currentLocation=angular.copy(g.location),g.searchFilter.forEach(function(b){var d=[{type:b,distance:25},{type:b,distance:20},{type:b,distance:15},{type:b,distance:10},{type:b,distance:5}];d.forEach(function(b){f=f.then(function(d){return c(d),a.getNearByPlaces(g.currentAddress,i.lat(),i.lng(),14,g.map,1609*b.distance,b.type)})})}),f.then(function(a){c(a),g.normalizedPlaces=b.sortByProperty(b.eliminateDuplicates(b.filterPlaces(e,g.location)),"distance"),console.log(g.normalizedPlaces),d.$apply(),g.filterPlacesByRadius(null,g.sliderModel),d.$apply(),h.setMap(g.map),g.setLoadingVisible(!1)})})},this.sortPlaces=function(a,c,d){d?g.filteredPlaces=b.sortByProperty(a,c).reverse():g.filteredPlaces=b.sortByProperty(a,c)},this.filterPlacesByRadius=function(a,b){var c=[];g.filteredPlaces=[],g.markers=[];for(var d=g.normalizedPlaces,e=0,f=0;f<d.length;f++)b>d[f].distance&&(c[e]=d[f],e++);g.filteredPlaces=c;for(var f=0;f<g.filteredPlaces.length;f++)g.markers.push({info:{address:g.filteredPlaces[f].address,name:g.filteredPlaces[f].name},id:g.filteredPlaces[f].place_id+","+f,coords:{latitude:g.filteredPlaces[f].location.latitude,longitude:g.filteredPlaces[f].location.longitude},key:g.markers.length+1,filter:g.filteredPlaces[f].filter});console.log(g.filteredPlaces)},this.clickListItem=function(b){for(var c=0;c<g.filteredPlaces.length;c++)g.filteredPlaces[c].selected=!1;b.selected=!b.selected,a.calculateAndDisplayRoute({lat:g.currentLocation.coords.latitude,lng:g.currentLocation.coords.longitude},{lat:b.location.latitude,lng:b.location.longitude}).then(function(a){h.setDirections(a)})},this.openInfoWindow=function(a){g.infoWindow.coords={latitude:a.position.lat(),longitude:a.position.lng()};var b=a.key.split(",")[1];g.infoWindow.name=g.filteredPlaces[b].name,g.infoWindow.address=g.filteredPlaces[b].address,g.infoWindow.show=!1,g.infoWindow.show=!0},this.markerEvents={click:function(a){g.infoWindow.show=!0,g.openInfoWindow(a);var b=a.key.split(",")[0];angular.element("#"+b).triggerHandler("click")}}}]),angular.module("instaPlaceApp").controller("listCtrl",["$scope",function(a){a.Math=window.Math,a.selectedItem=!1}]),angular.module("instaPlaceApp").controller("MainCtrl",["geolocationService",function(a){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}]),angular.module("instaPlaceApp").controller("AboutCtrl",function(){this.awesomeThings=["HTML5 Boilerplate","AngularJS","Karma"]}),angular.module("instaPlaceApp").controller("autocompleteCtrl",function(){this.place="",this.filterArray=[],this.placeIcons=[{name:"restaurant",boxShadow:"3px 3px 2px 2px rgba(0, 0, 0, 0.4)"},{name:"atm",boxShadow:"3px 3px 2px 2px rgba(0, 0, 0, 0.4)"},{name:"bar",boxShadow:"3px 3px 2px 2px rgba(0, 0, 0, 0.4)"},{name:"hospital",boxShadow:"3px 3px 2px 2px rgba(0, 0, 0, 0.4)"},{name:"grocery",boxShadow:"3px 3px 2px 2px rgba(0, 0, 0, 0.4)"},{name:"gas_station",boxShadow:"3px 3px 2px 2px rgba(0, 0, 0, 0.4)"}],this.addFilter=function(a,b){for(var a=a.split("-")[0],c="",d=0;d<this.placeIcons.length;d++)if(this.placeIcons[d].name.split("-")[0]==a){var e=this.filterArray.indexOf(a);-1==e?(c="inset 0 0 10px rgba(0, 0, 0, 0.8)",this.placeIcons[d].name=this.placeIcons[d].name+"-selected",this.filterArray.push(a)):(c="3px 3px 2px 2px rgba(0, 0, 0, 0.4)",this.placeIcons[d].name=this.placeIcons[d].name.split("-")[0],this.filterArray.splice(e,1)),this.placeIcons[d].boxShadow=c}b.searchFilter=this.filterArray},this.filterPlaces=function(a,b,c){for(var d=0;d<c.length;d++)1609*b<c[d].distance&&c.splice(d,1);console.log("changed")}}),angular.module("instaPlaceApp").service("geolocationService",["$http",function(a){this.yelpApi="http://api.yelp.com/v2/search/?",this.fourSquareApi="https://api.foursquare.com/v2/venues/explore?",this.categoryMap={foursquare:{restaurant:"4bf58dd8d48988d1c4941735",grocery:"4bf58dd8d48988d118951735",bar:"4bf58dd8d48988d116941735",airport:"4bf58dd8d48988d1ed931735",hospital:"4bf58dd8d48988d196941735",atm:"52f2ab2ebcbc57f1066b8b56",gas_station:"4bf58dd8d48988d113951735"},yelp:{restaurant:"restaurants",grocery:"grocery",bar:"bars",airport:"airports",hospital:"hospitals",atm:"atm",gas_station:"servicestations"}},this.getLocation=function(){return new Promise(function(a,b){navigator.geolocation?navigator.geolocation.getCurrentPosition(function(b){a(b)},function(){b("error")}):b("error")})},this.getAddress=function(a){var b=this;return new Promise(function(c,d){var e=new google.maps.Geocoder;e.geocode({location:{lat:a.latitude,lng:a.longitude}},function(a,e){e===google.maps.GeocoderStatus.OK&&a[0]?(b.currentAddress=a[0].formatted_address,c(a[0].formatted_address)):d("error")})})},this.getNearByPlaces=function(b,c,d,e,f,g,h){function i(a,b){for(var c="",d=a;d>0;--d)c+=b[Math.round(Math.random()*(b.length-1))];return c}function j(a,b,c,d,e,f,g,h){var j=angular.callbacks.$$counter.toString(36),k={callback:"angular.callbacks._"+j,oauth_consumer_key:"h_CfYvwNTS51n96wd1J8Yg",oauth_token:"YQHmflBE5VKvzjCgO5N3YkmsB4xIUNsa",oauth_signature_method:"HMAC-SHA1",oauth_timestamp:(new Date).getTime(),oauth_nonce:i(32,"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"),term:g[f],ll:a+","+b,radius_filter:e},l=oauthSignature.generate("GET",d,k,"yRk21bPPiZShxKn6stv2qth8nm4","Ptd6VdD63_AHgKNd_aezFO4iiuw",{encodeSignature:!1});return k.oauth_signature=l,h&&(k.offset=h),k}var k={},l=[];return l.push(a.jsonp(this.yelpApi,{params:j(c,d,b,this.yelpApi,g,h,this.categoryMap.yelp)})),l.push(a({method:"GET",url:this.fourSquareApi+"radius="+g+"&categoryId="+this.categoryMap.foursquare[h]+"&limit=50&ll="+c+","+d+"&v=20160806&client_id=HTYPWDKP445LBUZJLZWDR3C4D1GCOB4WNPW20UUGSJH0C32R&client_secret=V5VSZEHG1O4VNIGZSFAM11ZLHB2WKOEWOPMADS0XF1QRQMML"})),l.push(new Promise(function(a,b){var e=f,i={location:{lat:c,lng:d},radius:g,type:[h]},j=new google.maps.places.PlacesService(e);j.nearbySearch(i,function(b,c){c==google.maps.places.PlacesServiceStatus.OK&&a(b)})})),Promise.all(l).then(function(a){return new Promise(function(b,c){k[h]=a,b(k)})})},this.getLatLngFromAddress=function(a){return new Promise(function(b,c){var d=new google.maps.Geocoder;d.geocode({address:a},function(a,c){b(c===google.maps.GeocoderStatus.OK?a[0].geometry.location:"error")})})},this.getAllPlaceDetailsById=function(a){var b=this,c=[];return new Promise(function(d,e){var f=Promise.resolve();a.forEach(function(a){f=f.then(function(){return b.getPlaceDetailsById(a.place_id,a.geometry.location.lat(),a.geometry.location.lng())}).then(function(a){c.push(a)})["catch"](function(a){console.log(a)})}),f.then(function(){d(c)})})},this.getPlaceDetailsById=function(a,b,c){return new Promise(function(d,e){var f=new google.maps.Map(document.getElementById("map"),{center:{lat:b,lng:c},zoom:15}),g=new google.maps.places.PlacesService(f),h={placeId:a};g.getDetails(h,function(a,b){b==google.maps.places.PlacesServiceStatus.OK?d(a):(alert(b),d("error"))})})},this.calculateAndDisplayRoute=function(a,b){return new Promise(function(c,d){var e=new google.maps.DirectionsService;e.route({origin:a,destination:b,travelMode:google.maps.TravelMode.DRIVING},function(a,b){b===google.maps.DirectionsStatus.OK?c(a):(alert(b),c("error"))})})}}]),angular.module("instaPlaceApp").service("placeFilterService",["$http",function(a){this.filterPlaces=function(a,b){var c=[],d=0;for(var e in a)for(var f=a[e],g=0;g<f.length;g++)if("[object Object]"===Object.prototype.toString.call(f[g]))if(f[g].config.url.includes("yelp"))for(var h=0;h<f[g].data.businesses.length;h++){c[d]={},c[d].distance=(.000621371192*f[g].data.businesses[h].distance).toFixed(2),c[d].name=f[g].data.businesses[h].name,c[d].contact=f[g].data.businesses[h].display_phone,c[d].rating=f[g].data.businesses[h].rating,c[d].review=f[g].data.businesses[h].snippet_text;for(var i=[],j=0;j<f[g].data.businesses[h].location.display_address.length;j++)i.push(f[g].data.businesses[h].location.display_address[j]);i=i.join(),c[d].address=i,c[d].location=f[g].data.businesses[h].location.coordinate,c[d].datasrc="yelp",c[d].place_id=f[g].data.businesses[h].id,c[d].filter=e,c[d].selected=!1,d++}else for(var k=f[g].data.response.groups[0].items,h=0;h<k.length;h++){c[d]={};var l=k[h].venue;c[d].distance=(.000621371192*l.location.distance).toFixed(2);for(var i=[],j=0;j<l.location.formattedAddress.length;j++)i.push(l.location.formattedAddress[j]);i=i.join(),c[d].address=i,c[d].rating=5*l.rating/10,c[d].name=l.name,c[d].location={latitude:l.location.lat,longitude:l.location.lng},c[d].contact=l.contact.formattedPhone,k[h].tips&&(c[d].review=k[h].tips[0].text),c[d].datasrc="foursquare",c[d].filter=e,c[d].place_id=l.id,c[d].selected=!1,d++}else for(var m=f[g],j=0;j<m.length;j++){c[d]={};var n=m[j];c[d].rating=n.rating,c[d].name=n.name,c[d].location={latitude:n.geometry.location.lat(),longitude:n.geometry.location.lng()},c[d].distance=(.000621371192*this.calcDistance(b.coords.latitude,b.coords.longitude,n.geometry.location.lat(),n.geometry.location.lng())).toFixed(2),c[d].address=n.vicinity,c[d].datasrc="google",c[d].filter=e,c[d].place_id=n.id,c[d].selected=!1,d++}return c},this.eliminateDuplicates=function(a){for(var b=[],c=[],d=0,e=0;e<a.length;e++)b[a[e].distance+","+a[e].name]?a[e].rating&&a[e].review&&(b[a[e].distance+","+a[e].name]=a[e]):b[a[e].distance+","+a[e].name]=a[e];for(var f in b)c[d++]=b[f];return c},this.calcDistance=function(a,b,c,d){function e(a){return a*(Math.PI/180)}var f=6371,g=e(c-a),h=e(d-b),i=Math.sin(g/2)*Math.sin(g/2)+Math.cos(e(a))*Math.cos(e(c))*Math.sin(h/2)*Math.sin(h/2),j=2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i)),k=f*j;return 1e3*k},this.sortByProperty=function(a,b){return a.sort(function(a,c){return a[b]==c[b]?0:a[b]<c[b]?-1:1})}}]),angular.module("instaPlaceApp").run(["$templateCache",function(a){a.put("views/autocomplete.html",'<div class="container" id="toolbar"> <ul class="toolbar-panel"> <li> <div class="round-button" ng-click="homePage.setLocation()"></div> </li> <li><input type="text" placeholder="Enter a location" ng-model="homePage.currentAddress" class="searchBox" ng-autocomplete ng-model="autocomplete" options="options" details="details"></li> <li> <slider ng-model="homePage.sliderModel" min="1" step="0.2" max="25" class="customSlider" on-stop-slide="homePage.filterPlacesByRadius($event, value)"></slider> </li> <li><button type="button" class="btn btn-danger" ng-click="homePage.searchNearByPlaces()">Search</button></li> <div class="filters" ng-repeat="placeIcon in autocomplete.placeIcons"> <div class="{{placeIcon.name}}" style="display: inline-block; background-image: url(\'../images/{{placeIcon.name}}.png\'); box-shadow: {{placeIcon.boxShadow}}" ng-click="autocomplete.addFilter(placeIcon.name, homePage)"></div> </div> </ul> </div>'),a.put("views/describePlace.html",'<div class="detailPanel" ng-if="homePage.place"> <div class="row"> <img class="parallel-div" id="place-icon" ng-src="{{homePage.place.icon}}"> <div class="parallel-div" id="place-name">{{homePage.place.name}}</div> </div> <div class="row"> <div class="detail">{{homePage.place.formatted_address}}</div> </div> <div class="row"> <p>{{homePage.place.rating}}</p> </div> <div class="row"> <div class="col-md-4 text-center" id="infoBox"> <div class="row"> <div class="glyphicon glyphicon-earphone"></div> </div> <div class="row">{{homePage.place.formatted_phone_number}}</div> </div> <div class="col-md-4" id="infoBox"></div> <div class="col-md-4" id="infoBox"></div>  </div> </div>'),a.put("views/home.html",'<div class="overlay-loader" ng-style="homePage.loadingStyle"> <div class="loader"> <div></div> <div></div> <div></div> <div></div> <div></div> <div></div> <div></div> </div> </div> <div class="row autocomplete"> <div ui-view="autocompleteView"></div> </div> <div class="row"> <!-- COLUMN ONE NAMED VIEW --> <div class="col-sm-3"> <div ui-view="listView"></div> </div> <!-- COLUMN ONE NAMED VIEW --> <div class="col-sm-9 mapWrapper"> <div ui-view="mapView"></div> </div> </div>'),a.put("views/listView.html",'<div class="contact-list panel panel-default"> <div class="panel-heading"> <input class="form-control" ng-model="search.name" placeholder="Search place.."> </div> <div class="panel-body"> <div class="ui-list-view-bordered" ui-list-view="place in homePage.filteredPlaces | filter:search"> <div id="{{place.place_id}}" ng-click="homePage.clickListItem(place, place.selected); place.selected" ng-class="{selected: place.selected}"> <div class="place">{{place.name}}<span class="distance">{{place.distance}}mi</span></div> <div ng-if="place.rating" class="stars"> <img src="../images/{{Math.floor(place.rating)}}{{Math.round(place.rating)}}stars.png"> </div> <div class="address" id="{{place.place_id}}">{{place.address}}</div> <div style="display: inline-block" ng-if="place.selected && place.review"><img class="comment" src="../images/comment.9bb21441.png"><span class="review">{{place.review}}</span></div> </div> </div> </div> </div>'),a.put("views/mapView.html",'<ui-gmap-google-map id="mymap" center="homePage.location.coords" zoom="homePage.mapZoom" options="options"> <ui-gmap-circle center="homePage.currentLocation.coords" stroke="homePage.gmapCircle.stroke" fill="homePage.gmapCircle.fill" radius="homePage.sliderModel*1609" visible control="homePage.gmapCircle.control"></ui-gmap-circle> <ui-gmap-marker coords="homePage.currentLocation.coords" options="mapConfig.currentLocationMarker.options" idkey="0"> </ui-gmap-marker> <ui-gmap-window closeclick="closeClick()" show="homePage.infoWindow.show" coords="homePage.infoWindow.coords"> <div class="infoWindow"> <div id="title">{{homePage.infoWindow.name}}</div> <div id="info">{{homePage.infoWindow.address}}</div> </div> </ui-gmap-window> <ui-gmap-marker ng-repeat="m in homePage.markers" coords="m.coords" idkey="m.id" options="mapConfig.markers[m.filter]" events="homePage.markerEvents"> </ui-gmap-marker> </ui-gmap-google-map>')}]);